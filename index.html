<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2907/2907150.png">
    <title>æˆ‘çš„ç”Ÿæ´»åŠ©æ‰‹ (v11.0 çµ•å°é‚„åŸç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script async src="//www.instagram.com/embed.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#64748b', 
                        accent: '#f59e0b',
                        recipe: '#ec4899', // ç²‰ç´…è‰²
                        book: '#2563eb' // è—è‰²
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f9fafb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [v-cloak] { display: none !important; }
        /* è¼‰å…¥ç•«é¢ */
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="h-screen flex justify-center overflow-hidden">

    <div id="loading-overlay">
        <div class="w-10 h-10 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 text-sm font-bold">åŠ©æ‰‹å•Ÿå‹•ä¸­...</p>
        <div id="js-errors" class="hidden text-red-500 text-xs mt-4 p-2 bg-red-50 rounded"></div>
    </div>

    <div id="app" v-cloak class="w-full max-w-md h-full bg-slate-50 flex flex-col shadow-2xl relative mx-auto h-screen hidden">
        
        <header class="px-5 py-4 bg-white shadow-sm z-10 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-xl font-bold text-slate-800">{{ currentTabTitle }}</h1>
                <div class="text-xs text-slate-400 mt-1">{{ todayDate }}</div>
            </div>
            <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                <span :class="['w-2 h-2 rounded-full', syncStatus === 'online' ? 'bg-green-500' : 'bg-red-500']"></span>
                <span class="text-[10px] font-medium text-slate-500">{{ syncStatusText }}</span>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 no-scrollbar pb-28 space-y-4">
            
            <div v-if="currentTab === 'calendar'" class="space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <button @click="changeMonth(-1)" class="p-2 text-slate-400">&lt;</button>
                        <span class="font-bold text-lg text-slate-800">{{ year }}å¹´ {{ month }}æœˆ</span>
                        <button @click="changeMonth(1)" class="p-2 text-slate-400">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2 font-medium"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div>
                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                        <div v-for="blank in firstDayOfMonth" :key="'b'+blank" class="h-10"></div>
                        <div v-for="day in daysInMonth" :key="day" @click="selectDate(day)" :class="['h-14 w-full mx-auto flex flex-col items-center justify-start rounded-lg cursor-pointer transition-all relative border border-transparent', selectedDate === day ? '!border-slate-800 bg-slate-50' : 'hover:bg-slate-50', isToday(day) ? 'text-blue-600 font-bold' : 'text-slate-700', getHoliday(day) ? 'bg-red-50 text-red-500' : '']">
                            <span class="mt-1">{{ day }}</span>
                            <span v-if="getHoliday(day)" class="text-[8px] text-red-500 leading-none px-1 text-center font-bold">{{ getHoliday(day) }}</span>
                            <div v-if="hasTask(day)" class="mt-1 w-1 h-1 rounded-full" :class="selectedDate === day ? 'bg-slate-800' : 'bg-amber-400'"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 shadow-sm border-t-4 border-slate-200">
                    <h3 class="text-sm font-bold text-slate-500 mb-3 flex items-center gap-2"><span>{{ month }}æœˆ{{ selectedDate }}æ—¥ è¡Œç¨‹</span></h3>
                    <div class="bg-slate-50 p-3 rounded-xl mb-4 space-y-2 border border-slate-100">
                        <input v-model="calForm.title" type="text" placeholder="äº‹é …" class="w-full bg-white p-2 rounded text-sm outline-none border border-slate-200">
                        <div class="flex gap-2">
                            <input v-model="calForm.who" type="text" placeholder="èª°" class="w-1/3 bg-white p-2 rounded text-sm outline-none border border-slate-200">
                            <div class="flex-1 flex gap-1">
                                <select v-model="calForm.hour" class="flex-1 bg-white p-2 rounded text-sm outline-none border border-slate-200"><option value="" disabled>æ™‚</option><option v-for="h in 24" :value="(h-1).toString().padStart(2,'0')">{{ (h-1).toString().padStart(2,'0') }}</option></select>
                                <select v-model="calForm.minute" class="flex-1 bg-white p-2 rounded text-sm outline-none border border-slate-200"><option value="" disabled>åˆ†</option><option v-for="m in 12" :value="((m-1)*5).toString().padStart(2,'0')">{{ ((m-1)*5).toString().padStart(2,'0') }}</option></select>
                            </div>
                        </div>
                        <button @click="addCalendarEvent" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-medium">æ–°å¢è‡³æ—¥æ›†</button>
                    </div>
                    <div v-for="(task, index) in getSelectedDateTasks" :key="index" class="flex items-start gap-3 p-3 border-b border-slate-50 last:border-0">
                        <span class="text-xs font-bold text-slate-400 w-8 text-right">{{ task.time }}</span>
                        <div class="flex-1 text-sm text-slate-700">{{ task.title }} <span v-if="task.who" class="text-xs bg-amber-50 text-amber-600 px-1 rounded ml-1">@{{ task.who }}</span></div>
                        <button @click.stop="confirmRemoveCalEvent(task)" class="text-slate-300 hover:text-red-400 px-2">&times;</button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'tasks'" class="space-y-4">
                <div class="bg-white p-1.5 rounded-xl shadow-sm flex gap-1">
                    <button @click="taskSubTab = 'shopping'" :class="['flex-1 py-2 text-sm font-bold rounded-lg transition', taskSubTab === 'shopping' ? 'bg-orange-500 text-white shadow' : 'text-slate-400']">ğŸ›’ è³¼ç‰©</button>
                    <button @click="taskSubTab = 'todo'" :class="['flex-1 py-2 text-sm font-bold rounded-lg transition', taskSubTab === 'todo' ? 'bg-slate-800 text-white shadow' : 'text-slate-400']">ğŸ“ å¾…è¾¦</button>
                </div>
                <div v-if="taskSubTab === 'shopping'" class="space-y-4">
                    <div class="bg-white p-3 rounded-2xl shadow-sm space-y-2 border-l-4 border-orange-400">
                        <input v-model="shopForm.text" @keyup.enter="addShopItem" type="text" placeholder="è¦è²·ä»€éº¼..." class="w-full bg-transparent p-2 outline-none text-sm border-b border-orange-100">
                        <div class="flex items-center gap-2">
                            <input v-model="shopForm.location" @keyup.enter="addShopItem" type="text" placeholder="é‚£è£¡è²·" class="flex-1 bg-orange-50 p-2 rounded text-xs outline-none">
                            <button @click="addShopItem" class="bg-orange-400 text-white w-8 h-8 rounded-lg font-bold flex items-center justify-center">+</button>
                        </div>
                    </div>
                    <div v-for="(item, index) in shoppingList" :key="index" class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between border-l-4 border-orange-300">
                        <div class="flex items-center gap-3 flex-1">
                            <div @click="toggleShop(index)" :class="['w-5 h-5 rounded-full border cursor-pointer flex items-center justify-center transition', item.bought ? 'bg-orange-300 border-orange-300' : 'border-slate-300']"><span v-if="item.bought" class="text-white text-xs">âœ“</span></div>
                            <div class="flex flex-col"><span :class="['text-sm', item.bought ? 'line-through text-slate-300' : 'text-slate-700']">{{ item.text }}</span><span v-if="item.location" class="text-[10px] text-orange-400">{{ item.location }}</span></div>
                        </div>
                        <button @click="removeShop(index)" class="text-slate-300 hover:text-red-400 px-2">&times;</button>
                    </div>
                </div>
                <div v-if="taskSubTab === 'todo'" class="space-y-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border-l-4 border-slate-800">
                        <input v-model="todoForm.text" @keyup.enter="addTodo" type="text" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..." class="w-full bg-slate-50 p-2.5 rounded-lg text-sm outline-none">
                        <div class="flex gap-2">
                            <input v-model="todoForm.who" type="text" placeholder="è² è²¬äºº" class="w-1/3 bg-slate-50 p-2 rounded-lg text-xs outline-none">
                            <input v-model="todoForm.date" type="date" class="flex-1 bg-slate-50 p-2 rounded-lg text-xs outline-none text-slate-500">
                            <button @click="addTodo" class="bg-slate-800 text-white px-4 rounded-lg">+</button>
                        </div>
                    </div>
                    <div v-for="(item, index) in todos" :key="index" class="bg-white p-3 rounded-xl shadow-sm flex flex-col gap-2">
                        <div class="flex items-center gap-3">
                            <div @click="toggleTodo(index)" :class="['w-5 h-5 rounded border cursor-pointer flex items-center justify-center transition', item.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300']"><span v-if="item.done" class="text-white text-xs">âœ“</span></div>
                            <span :class="['flex-1 text-sm', item.done ? 'line-through text-slate-300' : 'text-slate-700']">{{ item.text }}</span>
                            <button @click="removeTodo(index)" class="text-slate-300 hover:text-red-400">&times;</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'recipe'" class="space-y-4">
                <div class="flex gap-2">
                    <div class="bg-white p-1.5 rounded-xl shadow-sm flex gap-1 flex-1">
                        <button @click="recipeFilter = 'main'" :class="['flex-1 py-2 text-sm font-bold rounded-lg transition', recipeFilter === 'main' ? 'bg-recipe text-white shadow' : 'text-slate-400']">ğŸœ ä¸»é£Ÿ</button>
                        <button @click="recipeFilter = 'dessert'" :class="['flex-1 py-2 text-sm font-bold rounded-lg transition', recipeFilter === 'dessert' ? 'bg-recipe text-white shadow' : 'text-slate-400']">ğŸ° ç”œå“</button>
                    </div>
                 </div>
                 
                 <div class="relative">
                     <input v-model="recipeSearch" type="text" placeholder="æœå°‹é£Ÿè­œ..." class="w-full bg-white p-3 rounded-xl shadow-sm outline-none text-sm pl-10 border border-slate-100">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 absolute left-3 top-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                 </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border-l-4 border-pink-400">
                    <input v-model="recipeForm.title" type="text" placeholder="é£Ÿè­œåç¨±..." class="w-full p-2.5 bg-slate-50 rounded-lg text-sm outline-none">
                    <input v-model="recipeForm.videoUrl" type="text" placeholder="YouTube æˆ– Instagram Reel é€£çµ..." class="w-full p-2.5 bg-slate-50 rounded-lg text-xs outline-none">
                    <textarea v-model="recipeForm.content" placeholder="é£Ÿæèˆ‡åšæ³•..." class="w-full h-20 p-2.5 bg-slate-50 rounded-lg outline-none resize-none text-xs text-slate-600"></textarea>
                    
                    <div class="flex gap-2 text-xs">
                        <label class="flex items-center gap-1 bg-slate-100 px-3 py-2 rounded-lg text-slate-500 cursor-pointer"><input type="radio" v-model="recipeForm.type" value="main"> ä¸»é£Ÿ</label>
                        <label class="flex items-center gap-1 bg-slate-100 px-3 py-2 rounded-lg text-slate-500 cursor-pointer"><input type="radio" v-model="recipeForm.type" value="dessert"> ç”œå“</label>
                        <label class="flex-1 bg-pink-50 text-pink-500 rounded-lg flex items-center justify-center gap-1 py-2 cursor-pointer border border-pink-100">ğŸ“· åŠ ç…§ç‰‡<input type="file" @change="handleRecipeImages" accept="image/*" multiple class="hidden"></label>
                        <button @click="addRecipe" class="bg-recipe text-white px-4 rounded-lg font-bold">æ–°å¢</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3 pb-20">
                    <div v-for="(item, index) in filteredRecipes" :key="index" @click="openRecipeModal(item)" class="bg-white p-3 rounded-xl shadow-sm flex gap-3 relative cursor-pointer border border-transparent hover:border-pink-200 transition">
                         <div class="w-24 h-24 bg-slate-100 rounded-lg overflow-hidden flex items-center justify-center shrink-0 border border-slate-100 relative">
                            <img v-if="item.images && item.images.length > 0" :src="item.images[0]" class="w-full h-full object-cover img-square">
                            <div v-else-if="item.videoUrl && item.videoUrl.includes('instagram.com')" class="w-full h-full flex items-center justify-center bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 text-white text-3xl absolute inset-0">ğŸ“¸</div>
                            <div v-else-if="item.videoUrl && item.videoUrl.includes('youtu')" class="w-full h-full flex items-center justify-center bg-red-600 text-white text-3xl absolute inset-0">â–¶</div>
                            <span v-else class="text-2xl">ğŸ²</span>
                        </div>
                        <div class="flex-1 overflow-hidden py-1">
                            <h4 class="font-bold text-slate-800 text-sm mb-1">{{ item.title }}</h4>
                            <div class="text-[10px] text-pink-500 mb-1" v-if="item.videoUrl">{{ item.videoUrl.includes('instagram.com') ? 'Instagram Reel' : 'YouTube å½±ç‰‡' }}</div>
                            <div class="text-[10px] text-slate-500 line-clamp-3 bg-slate-50 p-1.5 rounded">{{ item.content }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'edu'" class="space-y-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border-l-4 border-sky-400">
                    <textarea v-model="eduForm.text" placeholder="è¼¸å…¥æ•™é¤Šç­†è¨˜..." class="w-full h-20 bg-slate-50 p-3 rounded-xl text-sm outline-none resize-none border border-slate-100"></textarea>
                    <div class="flex gap-3">
                        <label class="flex-1 bg-sky-50 text-sky-600 rounded-lg flex items-center justify-center gap-2 py-2 cursor-pointer border border-sky-100">ğŸ“· åŠ åœ–ç‰‡<input type="file" @change="handleEduImage" accept="image/*" class="hidden"></label>
                        <button @click="addEduNote" class="flex-1 bg-slate-800 text-white rounded-lg py-2 text-xs font-bold">æ–°å¢ç­†è¨˜</button>
                    </div>
                </div>
                <div v-for="(item, index) in eduList" :key="index" class="bg-white p-4 rounded-xl shadow-sm flex flex-col gap-3">
                    <div v-if="item.type === 'text'" class="text-slate-700 text-sm whitespace-pre-wrap">{{ item.content }}</div>
                    <img v-else :src="item.content" class="w-full rounded-lg bg-slate-100">
                    <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                        <span class="text-[10px] text-slate-400">{{ item.date }}</span>
                        <button @click="removeEdu(index)" class="text-slate-300 hover:text-red-400 text-xs">åˆªé™¤</button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'book'" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div @click="toggleBookFilter('Kobe')" :class="['p-3 rounded-xl text-center shadow-sm border-b-4 cursor-pointer transition', bookFilter === 'Kobe' ? 'bg-indigo-50 border-indigo-500' : 'bg-white border-indigo-200']">
                        <div class="text-xs text-slate-400 font-bold mb-1">Kobe è®€äº†</div>
                        <div class="text-2xl font-bold text-indigo-500">{{ stats.kobe }} <span class="text-xs text-slate-300">æœ¬</span></div>
                    </div>
                    <div @click="toggleBookFilter('Luka')" :class="['p-3 rounded-xl text-center shadow-sm border-b-4 cursor-pointer transition', bookFilter === 'Luka' ? 'bg-teal-50 border-teal-500' : 'bg-white border-teal-200']">
                        <div class="text-xs text-slate-400 font-bold mb-1">Luka è®€äº†</div>
                        <div class="text-2xl font-bold text-teal-500">{{ stats.luka }} <span class="text-xs text-slate-300">æœ¬</span></div>
                    </div>
                </div>
                
                <div class="bg-white p-3 rounded-xl shadow-sm border border-indigo-100 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <input v-model="localBookSearch" type="text" placeholder="æœå°‹å·²è¨˜éŒ„çš„æ›¸..." class="flex-1 outline-none text-sm text-slate-700">
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm space-y-3 border-l-4 border-indigo-400 relative">
                    <div class="flex gap-2">
                        <input v-model="bookForm.searchText" @keyup.enter="searchBooks" type="text" placeholder="æ–°å¢: ç¶²ä¸Šæœæ›¸å (Google)..." class="flex-1 bg-slate-50 p-2 rounded-lg text-sm outline-none">
                        <button @click="searchBooks" class="bg-book text-white px-4 py-2 rounded-lg text-xs font-bold whitespace-nowrap flex items-center">
                            <span v-if="isSearching" class="animate-spin mr-1">C</span> æœæ›¸
                        </button>
                    </div>
                    <div v-if="searchResults.length > 0" class="bg-slate-50 rounded-lg p-2 border max-h-60 overflow-y-auto space-y-2">
                        <div v-for="book in searchResults" :key="book.id" @click="selectBook(book)" class="flex gap-3 bg-white p-2 rounded cursor-pointer items-center border border-slate-100 hover:bg-indigo-50">
                            <img :src="book.cover || 'https://via.placeholder.com/50'" class="w-10 h-14 object-cover rounded shadow-sm">
                            <div class="flex-1 font-bold text-xs">{{ book.title }} <br> <span class="text-gray-400 font-normal">{{book.author}}</span></div>
                        </div>
                    </div>
                    <div v-if="bookForm.title" class="pt-2 border-t border-slate-100 space-y-3 animate-pulse">
                        <div class="flex items-center gap-3 bg-indigo-50 p-2 rounded">
                            <img v-if="bookForm.tempCover" :src="bookForm.tempCover" class="w-10 h-14 object-cover rounded">
                            <div class="flex-1 font-bold text-sm text-indigo-900">{{ bookForm.title }}</div>
                            <button @click="clearSelection" class="text-xs text-red-500">é‡é¸</button>
                        </div>
                        <div class="flex gap-2 text-xs">
                            <button @click="toggleReader('Kobe')" :class="['flex-1 py-2 rounded-lg transition font-bold', bookForm.readers.includes('Kobe') ? 'bg-indigo-500 text-white' : 'bg-slate-100']">Kobe</button>
                            <button @click="toggleReader('Luka')" :class="['flex-1 py-2 rounded-lg transition font-bold', bookForm.readers.includes('Luka') ? 'bg-teal-500 text-white' : 'bg-slate-100']">Luka</button>
                        </div>
                        <button @click="addBook" class="w-full bg-book text-white py-2 rounded-lg text-xs font-bold shadow-md">ç¢ºèªåŠ å…¥</button>
                    </div>
                </div>
                <div v-for="(book, index) in filteredBooks" :key="book.id" class="bg-white p-3 rounded-xl shadow-sm flex gap-3 relative border border-slate-100">
                    <div class="w-16 h-24 rounded-lg overflow-hidden shrink-0 bg-slate-50 border shadow-inner">
                        <img v-if="book.cover" :src="book.cover" class="w-full h-full object-cover">
                        <span v-else class="text-2xl flex items-center justify-center h-full">ğŸ“š</span>
                    </div>
                    <div class="flex-1 flex flex-col justify-center">
                        <h4 class="font-bold text-slate-800 text-sm leading-tight mb-1">{{ book.title }}</h4>
                        <div class="text-xs text-slate-400 mb-2">{{ book.date }}</div>
                        <div class="flex gap-1"><span v-for="reader in book.readers" :class="['px-2 py-0.5 rounded text-[10px] font-bold text-white', reader==='Kobe'?'bg-indigo-500':'bg-teal-500']">{{ reader }}</span></div>
                    </div>
                    <button @click="confirmRemoveBook(book)" class="absolute top-2 right-2 text-slate-300 hover:text-red-400 p-2">&times;</button>
                </div>
            </div>

        </main>

        <transition name="modal">
            <div v-if="showRecipeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                <div class="bg-white w-full max-w-md max-h-[85vh] rounded-2xl overflow-hidden flex flex-col shadow-2xl modal-container">
                    <div class="flex-1 overflow-y-auto p-0 bg-white">
                        <div class="w-full bg-black shrink-0 relative" style="min-height: 250px;">
                            <iframe v-if="getEmbedUrl(recipeInView.videoUrl)" :src="getEmbedUrl(recipeInView.videoUrl)" class="w-full h-full absolute inset-0" frameborder="0" allowfullscreen></iframe>
                            <div v-else-if="recipeInView.videoUrl && recipeInView.videoUrl.includes('instagram')" class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 p-10 text-center">
                                <span class="text-5xl mb-4 text-white">ğŸ“¸</span>
                                <div class="text-white font-bold mb-4">Instagram å½±ç‰‡</div>
                                <a :href="recipeInView.videoUrl" target="_blank" class="bg-white text-pink-600 px-6 py-2 rounded-full text-sm font-bold shadow-xl">é»æ“Šé–‹å•Ÿ Instagram</a>
                            </div>
                            <img v-else-if="recipeInView.images && recipeInView.images.length" :src="recipeInView.images[0]" class="w-full h-full object-contain">
                            <button @click="showRecipeModal=false" class="absolute top-3 right-3 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">&times;</button>
                        </div>
                        <div class="p-5">
                            <h2 class="text-xl font-bold text-slate-800 mb-2">{{recipeInView.title}}</h2>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">{{recipeInView.type}}</span>
                            <p class="text-sm text-slate-600 mt-4 whitespace-pre-wrap leading-relaxed">{{recipeInView.content}}</p>
                        </div>
                    </div>
                    <div class="p-4 border-t flex gap-3 bg-white">
                        <button @click="confirmDeleteRecipe(recipeInView)" class="flex-1 py-3 text-red-500 font-bold bg-red-50 rounded-lg">åˆªé™¤</button>
                        <button @click="showRecipeModal=false" class="flex-1 py-3 bg-slate-800 text-white font-bold rounded-lg">é—œé–‰</button>
                    </div>
                </div>
            </div>
        </transition>

        <nav class="absolute bottom-0 w-full bg-white border-t border-slate-100 px-2 py-2 flex justify-between items-center z-20 pb-6 shrink-0 text-slate-400">
            <button v-for="tab in ['calendar', 'tasks', 'recipe', 'edu', 'book']" @click="currentTab = tab" :class="['flex flex-col items-center gap-1 w-1/5 transition', currentTab === tab ? (tab==='recipe'?'text-recipe':tab==='book'?'text-book':'text-slate-800') : '']">
                <span class="text-2xl">{{ {'calendar':'ğŸ“…','tasks':'ğŸ“','recipe':'ğŸ³','edu':'ğŸ“','book':'ğŸ“–'}[tab] }}</span>
                <span class="text-[10px] font-bold">{{ {'calendar':'æ—¥æ›†','tasks':'ä»»å‹™','recipe':'é£Ÿè­œ','edu':'æ•™é¤Š','book':'é–±è®€'}[tab] }}</span>
            </button>
        </nav>
    </div>

    <script>
        window.onerror = function(msg) { document.getElementById('js-errors').innerHTML += `<div>${msg}</div>`; document.getElementById('js-errors').classList.remove('hidden'); };
        const { createApp, ref, computed, reactive, watch, toRaw, nextTick } = Vue;

        const firebaseConfig = { apiKey: "AIzaSyBm-HP5HO5cCbT7ciiye5ZzoMW5BDa6_EI", authDomain: "my-family-app-8dd29.firebaseapp.com", projectId: "my-family-app-8dd29", storageBucket: "my-family-app-8dd29.firebasestorage.app", messagingSenderId: "505912170720", appId: "1:505912170720:web:e8a5d42e6c5cef062d1885", measurementId: "G-J0SZDCDM16" };
        
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            createApp({
                setup() {
                    // Force Show UI after 1.5s
                    setTimeout(() => { document.getElementById('loading-overlay').classList.add('fade-out'); setTimeout(()=>document.getElementById('loading-overlay').style.display='none', 500); document.getElementById('app').classList.remove('hidden'); }, 1500);

                    const currentTab = ref('calendar');
                    const taskSubTab = ref('shopping');
                    const LOCAL_IMG_KEY = 'my-family-app-images';
                    const localImages = JSON.parse(localStorage.getItem(LOCAL_IMG_KEY) || '{"eduImages": [], "bookCovers": [], "recipeImages": []}');
                    
                    const calendarEvents = ref([]); const todos = ref([]); const shoppingList = ref([]); const eduList = ref([]); const bookList = ref([]); const recipeList = ref([]);
                    const isSearching = ref(false); const syncStatus = ref('offline');
                    const syncStatusText = computed(() => syncStatus.value === 'online' ? 'å·²åŒæ­¥' : 'é›¢ç·š');
                    const syncStatusClass = computed(() => `status-${syncStatus.value}`);
                    let isRemoteUpdate = false; 

                    db.collection("familyApp").doc("sharedData").onSnapshot((doc) => {
                        if (doc.exists) {
                            isRemoteUpdate = true; const data = doc.data();
                            calendarEvents.value = data.calendarEvents || []; todos.value = data.todos || []; shoppingList.value = data.shoppingList || [];
                            const remoteEdu = data.eduList || []; const localEduImages = localImages.eduImages || []; eduList.value = [...remoteEdu, ...localEduImages].sort((a,b) => new Date(b.date) - new Date(a.date));
                            const remoteBooks = data.bookList || []; const localCovers = localImages.bookCovers || []; bookList.value = remoteBooks.map(book => { if (book.cover && book.cover.startsWith('http')) return book; const foundCover = localCovers.find(c => c.id === book.id); return { ...book, cover: foundCover ? foundCover.cover : null }; }).sort((a,b) => new Date(b.date) - new Date(a.date));
                            const remoteRecipes = data.recipeList || []; const localRecipeImages = localImages.recipeImages || []; recipeList.value = remoteRecipes.map(r => { const foundRecord = localRecipeImages.find(img => img.id === r.id); let imgs = []; if (foundRecord) { if (foundRecord.images) imgs = foundRecord.images; else if (foundRecord.image) imgs = [foundRecord.image]; } return { ...r, images: imgs }; });
                            syncStatus.value = 'online'; setTimeout(() => isRemoteUpdate = false, 500);
                        } else { db.collection("familyApp").doc("sharedData").set({ calendarEvents: [], todos: [], shoppingList: [], eduList: [], bookList: [], recipeList: [] }); syncStatus.value = 'online'; }
                    }, err => { document.getElementById('js-errors').innerText = "é€£ç·šå¤±æ•—: " + err.message; document.getElementById('js-errors').classList.remove('hidden'); });

                    let saveTimeout = null;
                    const saveToCloud = () => {
                        if (isRemoteUpdate) return; syncStatus.value = 'syncing'; clearTimeout(saveTimeout);
                        saveTimeout = setTimeout(async () => {
                            try {
                                const eduTextOnly = eduList.value.filter(item => item.type === 'text');
                                const booksForCloud = bookList.value.map(b => (b.cover && b.cover.startsWith('http')) ? b : { ...b, cover: null });
                                const recipesForCloud = recipeList.value.map(({ images, ...rest }) => rest);
                                await db.collection("familyApp").doc("sharedData").set({ calendarEvents: toRaw(calendarEvents.value), todos: toRaw(todos.value), shoppingList: toRaw(shoppingList.value), eduList: toRaw(eduTextOnly), bookList: toRaw(booksForCloud), recipeList: toRaw(recipesForCloud) }, { merge: true });
                                syncStatus.value = 'online';
                            } catch (e) { syncStatus.value = 'offline'; }
                        }, 1000);
                    };

                    watch([calendarEvents, todos, shoppingList], saveToCloud, { deep: true });
                    watch(eduList, (nv) => { localImages.eduImages = nv.filter(i => i.type === 'image'); localStorage.setItem(LOCAL_IMG_KEY, JSON.stringify(localImages)); saveToCloud(); }, { deep: true });
                    watch(bookList, (nv) => { localImages.bookCovers = nv.filter(b => b.cover && !b.cover.startsWith('http')).map(b => ({ id: b.id, cover: b.cover })); localStorage.setItem(LOCAL_IMG_KEY, JSON.stringify(localImages)); saveToCloud(); }, { deep: true });
                    watch(recipeList, (nv) => { localImages.recipeImages = nv.filter(r => r.images && r.images.length > 0).map(r => ({ id: r.id, images: r.images })); localStorage.setItem(LOCAL_IMG_KEY, JSON.stringify(localImages)); saveToCloud(); }, { deep: true });

                    const now = new Date(); const year = ref(now.getFullYear()); const month = ref(now.getMonth() + 1); const selectedDate = ref(now.getDate());
                    const calForm = reactive({ title: '', who: '', hour: '', minute: '' });
                    const daysInMonth = computed(() => new Date(year.value, month.value, 0).getDate());
                    const firstDayOfMonth = computed(() => new Date(year.value, month.value - 1, 1).getDay());
                    const vicHolidays2026 = { '2026-1-1': "New Year's Day", '2026-1-26': "Australia Day", '2026-3-9': "Labour Day", '2026-4-3': "Good Friday", '2026-4-4': "Saturday before Easter", '2026-4-5': "Easter Sunday", '2026-4-6': "Easter Monday", '2026-4-25': "Anzac Day", '2026-6-8': "King's Birthday", '2026-11-3': "Melbourne Cup", '2026-12-25': "Christmas Day", '2026-12-26': "Boxing Day" };
                    const getHoliday = (d) => vicHolidays2026[`${year.value}-${month.value}-${d}`] || null;
                    const changeMonth = (d) => { month.value += d; if (month.value > 12) { month.value = 1; year.value++; } else if (month.value < 1) { month.value = 12; year.value--; } };
                    const selectDate = (d) => selectedDate.value = d;
                    const isToday = (d) => (new Date()).getDate() === d && (new Date()).getMonth()+1 === month.value;
                    const hasTask = (d) => calendarEvents.value.some(e => e.date === `${year.value}-${month.value}-${d}`);
                    const getSelectedDateTasks = computed(() => calendarEvents.value.filter(e => e.date === `${year.value}-${month.value}-${selectedDate.value}`).sort((a,b) => a.time.localeCompare(b.time)));
                    const addCalendarEvent = () => { if(calForm.title.trim()) { let t = 'å…¨æ—¥'; if (calForm.hour && calForm.minute) t = `${calForm.hour}:${calForm.minute}`; calendarEvents.value.push({ id: Date.now(), date: `${year.value}-${month.value}-${selectedDate.value}`, title: calForm.title, who: calForm.who, time: t }); calForm.title = ''; } };
                    const confirmRemoveCalEvent = (task) => { if(confirm('åˆªé™¤æ­¤è¡Œç¨‹?')) calendarEvents.value.splice(calendarEvents.value.indexOf(task), 1); };

                    const todoForm = reactive({ text: '', who: '', date: '' });
                    const addTodo = () => { if (todoForm.text.trim()) { todos.value.unshift({ text: todoForm.text, who: todoForm.who, date: todoForm.date, done: false, count: 0 }); todoForm.text = ''; } };
                    const removeTodo = (i) => todos.value.splice(i, 1);
                    const toggleTodo = (i) => todos.value[i].done = !todos.value[i].done;
                    const incrementTodo = (t) => t.count++;
                    const shopForm = reactive({ text: '', location: '' });
                    const addShopItem = () => { if (shopForm.text.trim()) { shoppingList.value.unshift({ text: shopForm.text, location: shopForm.location, bought: false }); shopForm.text = ''; } };
                    const removeShop = (i) => shoppingList.value.splice(i, 1);
                    const toggleShop = (i) => shoppingList.value[i].bought = !shoppingList.value[i].bought;

                    const recipeSearch = ref(''); const recipeFilter = ref('main'); const recipeForm = reactive({ title: '', content: '', videoUrl: '', type: 'main', tempImages: [], videoPreviewUrl: null });
                    const filteredRecipes = computed(() => {
                        let r = recipeList.value.filter(x => x.type === recipeFilter.value);
                        if (recipeSearch.value.trim()) { let k = recipeSearch.value.toLowerCase(); r = r.filter(x => x.title.toLowerCase().includes(k) || x.content.toLowerCase().includes(k)); }
                        return r;
                    });
                    
                    const getIgId = (u) => { if(!u) return null; let m = u.match(/(?:p|reel|reels)\/([a-zA-Z0-9_-]+)/); return m ? m[1] : null; };

                    watch(() => recipeForm.videoUrl, (url) => {
                        if(!url) { recipeForm.videoPreviewUrl = null; return; }
                        let ytMatch = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                        if (ytMatch && ytMatch[2].length === 11) {
                            recipeForm.videoPreviewUrl = `https://img.youtube.com/vi/${ytMatch[2]}/mqdefault.jpg`;
                        } else if (url.includes('instagram.com')) {
                            recipeForm.videoPreviewUrl = url; 
                        } else {
                            recipeForm.videoPreviewUrl = null;
                        }
                    });

                    const handleRecipeImages = (e) => { let f = e.target.files; if (f) { for (let i=0; i<f.length; i++) { let r = new FileReader(); r.onload = (ev) => recipeForm.tempImages.push(ev.target.result); r.readAsDataURL(f[i]); } } };
                    const removeTempImage = (i) => recipeForm.tempImages.splice(i, 1);
                    const addRecipe = () => { 
                        if (recipeForm.title.trim()) { 
                            let imgs = [...recipeForm.tempImages];
                            if (imgs.length === 0 && recipeForm.videoPreviewUrl && !recipeForm.videoPreviewUrl.includes('instagram.com')) {
                                imgs.push(recipeForm.videoPreviewUrl);
                            }
                            recipeList.value.unshift({ id: Date.now().toString(), title: recipeForm.title, content: recipeForm.content, type: recipeForm.type, videoUrl: recipeForm.videoUrl, images: imgs }); 
                            recipeForm.title = ''; recipeForm.content = ''; recipeForm.videoUrl = ''; recipeForm.tempImages = []; 
                        } 
                    };
                    const confirmDeleteRecipe = (t) => { if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) { let i = recipeList.value.indexOf(t); if (i>-1) recipeList.value.splice(i, 1); showRecipeModal.value = false; } };
                    const showRecipeModal = ref(false); const isEditingRecipe = ref(false); const recipeInView = ref({}); const recipeEditForm = reactive({ title: '', content: '', type: '', videoUrl: '', tempImages: [] });
                    const getEmbedUrl = (u) => { if (!u) return null; let m = u.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/); return (m && m[2].length === 11) ? 'https://www.youtube.com/embed/' + m[2] : null; };
                    
                    const openRecipeModal = (t) => { recipeInView.value = t; isEditingRecipe.value = false; showRecipeModal.value = true; nextTick(() => { if (window.instgrm) window.instgrm.Embeds.process(); }); };
                    const startEditRecipe = () => { isEditingRecipe.value = true; Object.assign(recipeEditForm, { title: recipeInView.value.title, content: recipeInView.value.content, type: recipeInView.value.type, videoUrl: recipeInView.value.videoUrl || '', tempImages: [...(recipeInView.value.images || [])] }); };
                    const handleEditRecipeImages = (e) => { const f = e.target.files; for(let i=0; i<f.length; i++){ let r = new FileReader(); r.onload = (ev) => recipeEditForm.tempImages.push(ev.target.result); r.readAsDataURL(f[i]); } };
                    const saveEditedRecipe = () => { Object.assign(recipeInView.value, { title: recipeEditForm.title, content: recipeEditForm.content, type: recipeEditForm.type, videoUrl: recipeEditForm.videoUrl, images: [...recipeEditForm.tempImages] }); isEditingRecipe.value = false; saveToCloud(); };

                    const eduForm = reactive({ text: '' });
                    const addEduNote = () => { if(eduForm.text.trim()){ eduList.value.unshift({ type: 'text', content: eduForm.text, date: (new Date()).toLocaleDateString(), shareCount: 0 }); eduForm.text = ''; } };
                    const handleEduImage = (e) => { let f = e.target.files[0]; if(f){ let r = new FileReader(); r.onload = (ev) => eduList.value.unshift({ type: 'image', content: ev.target.result, date: (new Date()).toLocaleDateString(), shareCount: 0 }); r.readAsDataURL(f); } };
                    const removeEdu = (i) => eduList.value.splice(i, 1);
                    const incrementShare = (t) => t.shareCount++;
                    
                    const bookForm = reactive({ searchText: '', title: '', readers: [], date: (new Date()).toISOString().split('T')[0], tempCover: null });
                    const searchResults = ref([]); const bookFilter = ref('all'); const localBookSearch = ref('');
                    const stats = computed(() => ({ kobe: bookList.value.filter(b => b.readers.includes('Kobe')).length, luka: bookList.value.filter(b => b.readers.includes('Luka')).length }));
                    const filteredBooks = computed(() => { let r = bookList.value; if (bookFilter.value !== 'all') r = r.filter(b => b.readers.includes(bookFilter.value)); if (localBookSearch.value.trim()) { let k = localBookSearch.value.toLowerCase(); r = r.filter(b => b.title.toLowerCase().includes(k)); } return r; });
                    const toggleBookFilter = (n) => bookFilter.value = (bookFilter.value === n) ? 'all' : n;
                    const toggleReader = (n) => bookForm.readers.includes(n) ? bookForm.readers = bookForm.readers.filter(x => x !== n) : bookForm.readers.push(n);
                    
                    // *** GOOGLE BOOKS (JSONP HACK for Localhost) ***
                    const searchBooks = async () => { 
                        if (!bookForm.searchText.trim()) return alert("è«‹è¼¸å…¥æ›¸å"); 
                        isSearching.value = true; 
                        searchResults.value = []; 
                        const script = document.createElement('script');
                        const cbName = 'googleBooksCallback_' + Date.now();
                        window[cbName] = (data) => {
                            if (data.items) {
                                searchResults.value = data.items.map(item => ({
                                    id: item.id,
                                    title: item.volumeInfo.title,
                                    author: item.volumeInfo.authors ? item.volumeInfo.authors[0] : 'Unknown',
                                    cover: item.volumeInfo.imageLinks ? item.volumeInfo.imageLinks.thumbnail.replace('http:', 'https:') : null
                                }));
                            } else { alert("æ‰¾ä¸åˆ°ç›¸é—œæ›¸æœ¬"); }
                            document.body.removeChild(script);
                            delete window[cbName];
                            isSearching.value = false;
                        };
                        script.src = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(bookForm.searchText)}&callback=${cbName}&maxResults=10`;
                        script.onerror = () => { alert("é€£ç·šå¤±æ•—"); isSearching.value = false; };
                        document.body.appendChild(script);
                    };
                    
                    const selectBook = (b) => { bookForm.title = b.title; bookForm.tempCover = b.cover; searchResults.value = []; };
                    const clearSelection = () => { bookForm.title = ''; bookForm.tempCover = null; };
                    const addBook = () => { if (bookForm.title.trim()) { bookList.value.unshift({ id: Date.now().toString(), title: bookForm.title, readers: [...bookForm.readers], date: bookForm.date, cover: bookForm.tempCover }); bookForm.title = ''; bookForm.readers = []; bookForm.tempCover = null; bookForm.searchText = ''; } };
                    const confirmRemoveBook = (t) => { if (confirm('åˆªé™¤è¨˜éŒ„ï¼Ÿ')) bookList.value.splice(bookList.value.indexOf(t), 1); };

                    const currentTabTitle = computed(() => ({ calendar: 'è¡Œç¨‹æ—¥æ›†', tasks: 'ä»»å‹™ä¸­å¿ƒ', recipe: 'ç§æˆ¿é£Ÿè­œ', edu: 'æ•™é¤Šç­†è¨˜', book: 'é–±è®€å­˜æ‘º' }[currentTab.value]));
                    const todayDate = computed(() => new Date().toLocaleDateString('zh-TW', { weekday: 'long', month: 'long', day: 'numeric' }));

                    return { currentTab, currentTabTitle, todayDate, syncStatusText, syncStatusClass, year, month, daysInMonth, firstDayOfMonth, selectedDate, calForm, changeMonth, selectDate, isToday, hasTask, getSelectedDateTasks, addCalendarEvent, removeCalEvent, confirmRemoveCalEvent, getHoliday, taskSubTab, todoForm, todos, addTodo, removeTodo, toggleTodo, incrementTodo, shopForm, shoppingList, addShopItem, removeShop, toggleShop, recipeSearch, recipeFilter, recipeForm, filteredRecipes, handleRecipeImages, removeTempImage, addRecipe, confirmDeleteRecipe, showRecipeModal, isEditingRecipe, recipeInView, openRecipeModal, startEditRecipe, recipeEditForm, handleEditRecipeImages, removeEditImage, saveEditedRecipe, getEmbedUrl, getIgId, eduForm, eduList, addEduNote, handleEduImage, removeEdu, incrementShare, bookList, bookForm, toggleReader, addBook, confirmRemoveBook, searchBooks, isSearching, searchResults, selectBook, clearSelection, stats, bookFilter, toggleBookFilter, filteredBooks, localBookSearch };
                }
            }).mount('#app');
        } catch (e) { document.getElementById('js-errors').innerText = "ç³»çµ±éŒ¯èª¤: " + e.message; document.getElementById('js-errors').classList.remove('hidden'); }
    </script>
</body>
</html>